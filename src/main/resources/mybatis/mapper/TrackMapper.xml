<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.founder.interservice.mapper.TrackMapper">


    <sql id="queryTrack_where">
      <if test="xxzjbh != null and xxzjbh != ''">
          and t.xxzjbh = #{xxzjbh}
      </if>
      <if test="objecttype != null and objecttype != '' ">
          and t.objecttype = #{objecttype}
      </if>
      <if test="objectvalue != null and objectvalue != ''">
          <choose>
              <when test="objectvalue.indexOf(',') > 0">
                  and t.objectvalue in (${objectvalue})
              </when>
              <otherwise>
                  and t.objectvalue = #{objectvalue}
              </otherwise>
          </choose>
      </if>
        <if test="kssj != null and kssj != ''">
            and to_date(t.timestr,'yyyy-MM-dd HH24:mi:ss') <![CDATA[>=]]> to_date(#{kssj},'yyyy-MM-dd HH24:mi:ss')
        </if>
        <if test="jssj != null and jssj != ''">
            and to_date(t.timestr,'yyyy-MM-dd HH24:mi:ss') <![CDATA[<]]> to_date(#{jssj},'yyyy-MM-dd HH24:mi:ss')
        </if>
    </sql>

    <select id="getTracks" parameterType="trackFilter" resultType="track">
        select
          tt.*
        from (
            select
            t.xxzjbh,
            t.address,
            t.objecttype,
            t.objecttypename,
            t.objectvalue,
            t.j,
            t.w,
            t.timestr,
            t.timestamp,
            rownum as rn
            from track t
            <where>
                <include refid="queryTrack_where"/>
                and rownum <![CDATA[ <= ]]> #{end }
            </where>
        )tt
        <where>
            and tt.rn <![CDATA[ > ]]> #{begin }
        </where>
        order by tt.timestamp desc
    </select>
    <select id="getTracksTotalCount" parameterType="trackFilter" resultType="java.lang.Integer">
        select count(*)
        from track t
        <where>
            <include refid="queryTrack_where"/>
        </where>
    </select>
    <!-- 根据多条件查询出现总次数在前五的记录数 -->
    <select id = "queryTrackBefore5" parameterType="trackFilter" resultType="track">
        select * from (
            select t.address as address,
                count(*) as timestr,
                t.j as j,
                t.w as w
                from track t
                <where>
                    <include refid="queryTrack_where"/>
                </where>
                group by t.address,t.j,t.w
                order by count(*) desc
        ) where rownum <![CDATA[ <= ]]> 5
    </select>
</mapper>